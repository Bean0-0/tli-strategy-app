{% extends "base.html" %}

{% block title %}Email Parser - TLi Trading Tool{% endblock %}

{% block content %}
<h1>Email Parser</h1>

<!-- Gmail Fetch Section -->
<div class="parser-section">
    <h2>üìß Fetch from Gmail</h2>
    <p class="help-text">Automatically fetch forwarded emails from tli.strategy.app@gmail.com (requires Gmail API setup)</p>
    
    <div class="form">
        <div class="form-row">
            <div class="form-group">
                <label for="max-results">Max Emails</label>
                <input type="number" id="max-results" value="10" min="1" max="50">
            </div>
            
            <div class="form-group">
                <label for="days-back">Days Back</label>
                <input type="number" id="days-back" value="7" min="1" max="30">
            </div>
        </div>
        
        <!-- Hidden buttons for manual use if needed -->
        <div style="display:none;">
            <button id="test-connection-btn" class="btn btn-secondary">Test Connection</button>
            <button id="fetch-gmail-btn" class="btn btn-primary">Fetch Emails</button>
        </div>
        <div id="loading-indicator" style="display:none; text-align:center; padding: 1rem;">
            <p>Loading more emails...</p>
        </div>
    </div>
</div>

<!-- Gmail Results -->
<div id="gmail-results" style="display:none;">
    <h3>Fetched Emails</h3>
    <div id="emails-list" style="max-height: 600px; overflow-y: auto;"></div>
    <div id="scroll-sentinel"></div>
</div>

<hr style="margin: 2rem 0;">

<!-- Manual Parse Section -->
<div class="parser-section">
    <h2>‚úçÔ∏è Manual Parse</h2>
    <p class="help-text">Paste the forwarded email content below. The parser will extract symbols, price levels, and fibonacci levels.</p>
    
    <div class="form">
        <div class="form-group">
            <label for="email-content">Email Content</label>
            <textarea id="email-content" rows="15" placeholder="Paste email content here..."></textarea>
        </div>
        
        <button id="parse-email-btn" class="btn btn-primary">Parse Email</button>
    </div>
</div>

<div id="parse-results" style="display:none;">
    <h2>Parsed Results</h2>
    
    <div class="results-section">
        <h3>Symbols Found</h3>
        <div id="symbols-list"></div>
    </div>
    
    <div class="results-section">
        <h3>Price Levels Extracted</h3>
        <div id="levels-list"></div>
    </div>
    
    <div class="results-section">
        <h3>Notes</h3>
        <div id="notes-content"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Test Gmail API connection
async function testGmailConnection() {
    try {
        const response = await fetch('/gmail/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ Gmail connection successful!\nConnected to: ${result.email}`);
        } else {
            alert(`‚ùå Connection failed: ${result.message}\n\nPlease check GMAIL_SETUP.md for setup instructions.`);
        }
    } catch (error) {
        alert(`‚ùå Error: ${error.message}\n\nMake sure Gmail API is configured. See GMAIL_SETUP.md`);
    }
}

// Global state for pagination
let nextPageToken = null;
let isLoading = false;
let observer = null;

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    // Initial fetch
    fetchFromGmail(false);
    
    // Setup infinite scroll observer
    const options = {
        root: document.getElementById('emails-list'),
        rootMargin: '100px',
        threshold: 0.1
    };
    
    observer = new IntersectionObserver(handleObserver, options);
});

function handleObserver(entries, observer) {
    entries.forEach(entry => {
        if (entry.isIntersecting && nextPageToken && !isLoading) {
            fetchFromGmail(true);
        }
    });
}

// Fetch emails from Gmail
async function fetchFromGmail(isLoadMore = false) {
    if (isLoading) return;
    isLoading = true;
    
    const loadingIndicator = document.getElementById('loading-indicator');
    loadingIndicator.style.display = 'block';
    
    const maxResults = document.getElementById('max-results').value;
    const daysBack = document.getElementById('days-back').value;
    
    try {
        const payload = {
            max_results: parseInt(maxResults),
            days_back: parseInt(daysBack)
        };
        
        if (isLoadMore && nextPageToken) {
            payload.page_token = nextPageToken;
        }
    
        const response = await fetch('/gmail/fetch-emails', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (!result.success) {
            console.error(`Error: ${result.message}`);
            return;
        }
        
        // Update pagination token
        nextPageToken = result.next_page_token;
        
        // Display emails
        const emailsList = document.getElementById('emails-list');
        const gmailResults = document.getElementById('gmail-results');
        gmailResults.style.display = 'block';
        
        if (!isLoadMore) {
            emailsList.textContent = '';
        }
        
        if (result.emails.length === 0 && !isLoadMore) {
            emailsList.innerHTML = '<p style="text-align:center; padding:1rem;">No emails found.</p>';
        } else {
            result.emails.forEach(email => {
                const emailItem = document.createElement('div');
                emailItem.className = 'email-item';
                
                const emailHeader = document.createElement('div');
                emailHeader.className = 'email-header';
                
                const subject = document.createElement('strong');
                subject.textContent = email.subject;
                
                const date = document.createElement('span');
                date.className = 'email-date';
                date.textContent = email.date;
                
                emailHeader.appendChild(subject);
                emailHeader.appendChild(date);
                
                const emailFrom = document.createElement('div');
                emailFrom.className = 'email-from';
                emailFrom.textContent = 'From: ' + email.sender;
                
                const emailSnippet = document.createElement('div');
                emailSnippet.className = 'email-snippet';
                emailSnippet.textContent = email.snippet;
                
                const parseButton = document.createElement('button');
                
                if (email.is_parsed) {
                    parseButton.className = 'btn btn-sm btn-outline-success';
                    parseButton.innerHTML = 'Parsed <i class="fas fa-check"></i>';
                    parseButton.title = "This email has already been processed";
                } else {
                    parseButton.className = 'btn btn-sm btn-primary';
                    parseButton.textContent = 'Parse This Email';
                }
                
                parseButton.dataset.messageId = email.id;
                parseButton.addEventListener('click', function() {
                    const btn = this;
                    const originalText = btn.innerHTML;
                    btn.textContent = 'Parsing...';
                    btn.disabled = true;
                    
                    parseGmailEmail(this.dataset.messageId)
                        .then(() => {
                            // On success, mark as parsed
                            btn.className = 'btn btn-sm btn-outline-success';
                            btn.innerHTML = 'Parsed <i class="fas fa-check"></i>';
                            btn.disabled = false;
                        })
                        .catch(() => {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        });
                });
                
                emailItem.appendChild(emailHeader);
                emailItem.appendChild(emailFrom);
                emailItem.appendChild(emailSnippet);
                emailItem.appendChild(parseButton);
                
                emailsList.appendChild(emailItem);
            });
        }
        
        // Monitor the last item for infinite scroll
        if (nextPageToken) {
            const lastItem = emailsList.lastElementChild;
            if (lastItem) {
                observer.disconnect();
                observer.observe(lastItem);
            }
        } else {
            observer.disconnect();
        }
        
    } catch (error) {
        console.error(`Error fetching emails: ${error.message}`);
    } finally {
        isLoading = false;
        loadingIndicator.style.display = 'none';
    }
}

// Parse a specific email from Gmail
async function parseGmailEmail(messageId) {
    try {
        const response = await fetch(`/gmail/parse-email/${messageId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (!result.success) {
            alert(`Error: ${result.message}`);
            throw new Error(result.message);
        }
        
        // Display the parsed data using safe DOM methods
        displayParsedData(result.parsed_data);
        
        document.getElementById('parse-results').style.display = 'block';
        
        // alert(result.message); // Optional: remove alert if button change is enough feedback
        
        // Scroll to results
        document.getElementById('parse-results').scrollIntoView({ behavior: 'smooth' });
        
        return result; // Resolve
    } catch (error) {
        alert(`Error parsing email: ${error.message}`);
        throw error; // Reject
    }
}

// Helper function to safely display parsed data
function displayParsedData(parsed) {
    // Display symbols safely
    const symbolsList = document.getElementById('symbols-list');
    symbolsList.textContent = '';
    
    const symbolsContainer = document.createElement('div');
    symbolsContainer.className = 'symbols';
    
    if (parsed.symbols && parsed.symbols.length > 0) {
        parsed.symbols.forEach(symbol => {
            const symbolTag = document.createElement('span');
            symbolTag.className = 'symbol-tag';
            symbolTag.textContent = `$${symbol}`;
            symbolsContainer.appendChild(symbolTag);
        });
    } else {
        const noSymbols = document.createElement('p');
        noSymbols.textContent = 'No symbols found';
        symbolsContainer.appendChild(noSymbols);
    }
    
    symbolsList.appendChild(symbolsContainer);
    
    // Display levels safely
    const levelsList = document.getElementById('levels-list');
    levelsList.textContent = '';
    
    const table = document.createElement('table');
    table.className = 'levels-table';
    
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    ['Symbol', 'Type', 'Price', 'Notes'].forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    const tbody = document.createElement('tbody');
    
    if (parsed.levels && parsed.levels.length > 0) {
        parsed.levels.forEach(level => {
            const row = document.createElement('tr');
            
            const symbolCell = document.createElement('td');
            const symbolStrong = document.createElement('strong');
            symbolStrong.textContent = `$${level.symbol}`;
            symbolCell.appendChild(symbolStrong);
            
            const typeCell = document.createElement('td');
            const badge = document.createElement('span');
            badge.className = 'badge';
            badge.textContent = level.type;
            typeCell.appendChild(badge);
            
            const priceCell = document.createElement('td');
            priceCell.textContent = `$${level.price.toFixed(2)}`;
            
            const notesCell = document.createElement('td');
            notesCell.textContent = level.notes || '-';
            
            row.appendChild(symbolCell);
            row.appendChild(typeCell);
            row.appendChild(priceCell);
            row.appendChild(notesCell);
            
            tbody.appendChild(row);
        });
    } else {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 4;
        cell.textContent = 'No levels found';
        row.appendChild(cell);
        tbody.appendChild(row);
    }
    
    table.appendChild(tbody);
    levelsList.appendChild(table);
    
    // Display notes safely
    const notesContent = document.getElementById('notes-content');
    notesContent.textContent = '';
    
    if (parsed.notes) {
        const pre = document.createElement('pre');
        pre.textContent = parsed.notes;
        notesContent.appendChild(pre);
    } else {
        const p = document.createElement('p');
        p.textContent = 'No notes extracted';
        notesContent.appendChild(p);
    }
}

// Manual parse function (existing)
async function parseEmail() {
    const content = document.getElementById('email-content').value.trim();
    
    if (!content) {
        alert('Please paste email content');
        return;
    }
    
    const response = await fetch('/email-parser/parse', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            email_content: content
        })
    });
    
    const result = await response.json();
    
    // Display parsed data using safe DOM methods
    displayParsedData(result);
    
    document.getElementById('parse-results').style.display = 'block';
    
    if (result.levels && result.levels.length > 0) {
        alert(`Successfully parsed! Found ${result.symbols.length} symbols and ${result.levels.length} price levels. Data has been saved to the database.`);
    }
}

// Add event listeners when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('test-connection-btn').addEventListener('click', testGmailConnection);
    document.getElementById('fetch-gmail-btn').addEventListener('click', fetchFromGmail);
    document.getElementById('parse-email-btn').addEventListener('click', parseEmail);
});
</script>
{% endblock %}
